\section{Analogue}

The design of the hardware is needed to interpret the projected maze.  To process the light input from the projector, a surface mount phototransistor (TEMT6200) is utilised to interpret the maze. The maze being projected down has black lines representing the path and the white areas of the maze as the barriers. The aim of the analogue design is to clearly differentiate between the black light and white light that are exposed to the light sensors, and represent them as a digital signal for the PSoC. This will require signal processing in the form of filtering, amplification, rectifying and digitising the signal.

\subsubsection*{Phototransistor Configuration}
A phototransistor can be set up in two configurations: common collector and common emitter configuration (See Appendix B: Figure 1 \& 2). In the common collector configuration, the output signal had better resolution as the different light frequencies were easily differentiated. However, the difference between the peak-to-peak voltages of the black light and white light at 2.13Vpk-pk and 1.79Vpk-pk respectively was very low, making it difficult to differentiate them. On the other hand, the resolution of the output signal in the common emitter configuration is slightly worse. For our application, the signal resolution is not important since there is no need to differentiate between the different light frequencies. We are more interested in having a larger difference in peak-to-peak voltage between the black light and white light at 1.8Vpk-pk and 0.28Vpk-pk respectively. Due to this, the common emitter configuration was chosen for the light sensors to clearly distinguish the black light from the white light of the maze. 
\\The current produced from the light sensor ranges from 7.5uA to 39uA based on the type of light it is exposed to. Due to this, the resistor in series needs to be large enough so that voltage across it, from sensing the black and white light, is distinguishable from each other. The value of 100KOhm was chosen so that the theoretical voltage range of the input signal is between 4.25V to 1.1V.

\subsubsection*{Filter}
In reality, the light sensor will also be subjected to other ambient light sources aside from the projector light in the room. The light sources in the room consists of the projector light, artificial ambient light, and natural ambient light which has a frequency of 120Hz, 100Hz and 0Hz respectively. To obtain the pure signals of the projected map, we need to filter out as much of the ambient light as possible. A high-pass filter with a corner frequency of 10Hz was designed to filter out the DC offset of the signal. 
\\Ideally, we would like to have a corner frequency at 105Hz to filter out the artificial ambient light as well. However, in practice, the filter will have a finite roll-off which means the 100 Hz signal will not be filtered since it is too close to the corner frequency. Also, our desired signal would be too close to the corner frequency, thus our desired signal would also be slightly filtered since the gain of the signal would be 0.707 around the corner frequency. Due to these limitations, we designed our high-pass filter with a corner frequency of 15 Hz instead so that only the DC component would be filtered out whilst maintaining the strength of the desired signal. To get a corner frequency of 15 Hz, we chose a 680KOhm resistor and a 15nF capacitor. Above the corner frequency the capacitor acts as a short circuit, therefore the resistor (R) of the light sensor and the resistor (Rf)  of the filter will act as a voltage divider, thus Rf must be significantly larger than R (See Appendix B: Figure 2). For this reason, we chose Rf to be 680KOhm which is significantly larger than R, so that the effect of the voltage divider is minuscule and our voltage into the filter is largely unchanged. 
\\The filtered signal is relatively small with an amplitude of 140 mV and ~0.8V for black and white light respectively, thus needs amplification. An active high pass filter is needed for the filtering of the DC component and the amplification of the signal. We designed our active high pass filter to have a gain of 5.7 so that our signal would now have a max voltage of 0.8V and 4.56V for black and white light respectively which would allow us to easily differentiate between them. 

\subsubsection*{Analogue vs Digital Output Signal}
The input signals into the PSoC can either be in analogue or digital form. If an analogue signal is passed into the PSoC,  the input voltage will have to be sampled by the PSoC ADC and then converted into a digital form. If a digital signal is passed into the PSoC, the signal processing would occur at real-time where the time delay will be due to the time constant of the circuit. Having a digital input will also dramatically simplify the code so that sampling logic does not need to be implemented. Therefore, the use of a digital signal into the PSoC was chosen to simplify software development. 
\\To implement the digital signal, we could use either a comparator or Schmitt-trigger to create high and low signals based on the analogue input signal.  A circuit using comparator has no hysteresis. As electrical signals are noisy, this can lead to the output signal flickering between high and low output when the input signal is reaching the threshold value. Whereas, a circuit using a Schmitt-trigger will reduce the flickering and lead to a clean transition between high and low outputs. Therefore, the decision was made to use a Schmitt-trigger in our circuit. The output signal from the active high-pass filter has a minimum voltage of 1.2V under white light and a maximum voltage of 0.4V under black light. Therefore, the threshold values selected were 0.6V for the low threshold voltage and 1.0V for the high threshold voltage.

\subsubsection*{Rectifier \& Smoothing Capacitor}
The input into the Schmitt-trigger is a periodic signal that is clipped at 0V. For black light, the signal fluctuates between  0-300mV. While in white light, the signal fluctuates between 0-4.5V. Without additional components, the Schmitt-trigger will flicker between a high and low output under white light. This is an undesirable characteristic as the output we want, should be constant under white light. To solve this issue, we used a rectifier to regulate the voltage so that the voltage was relatively constant and above the high threshold. The values selected for the rectifier were 22nF and 680KOhm, these values were a compromise between having a relatively constant voltage and a small time constant so that the time delay doesnâ€™t majorly impair the reaction time of the robot.
\subsubsection*{Sensor Array}
With our overall circuit complete, the light sensors needs to be positioned so that the robot will be able to navigate the maze under all possible scenarios. These scenarios include when the robot should follow a line and when it reaches events (intersections and dead ends).
\\Based on these scenarios, at the very least, we need two intersection sensors, two line sensors and a center sensor. Two line sensors on each side of the path are required so that the robot will be able to detect when it veers off the path and correct this. Two intersection sensors slightly further apart from the lines sensors are also needed to detect events which the robot will be able to react to. Finally, a center sensor will be needed to handle dead end events. The configurations we considered are seen in Appendix C: Figures 4-6. 
\\In the first configuration, as seen in Figure 4, the turning is simple since we can turn as soon as the intersection sensors are triggered. The distance of the front sensors are around the width of the robot so one of the wheels can be used as a pivot point when turning. The problem with this configuration is that the intersection sensors are too far apart so smaller intersections could not be detected. Additionally, the robot would turn too early when at a dead end due to how far the center sensor is from the center of the robot.
\\In the second array, as seen in Figure 5, the distance between the intersection sensors are shorter so that smaller intersections could be detected. All the sensors are also moved closer to the center to prevent early turning. However, this changes the pivot point for turning, thus we would now need to correctly determine when to turn after detecting the event as opposed to the previous arrangement.
\\Finally, Figure 6 shows our final sensor arrangement that is implemented in our final product. The new arrangement fixes the aforementioned issues. The intersection sensors will now indicate when to turn, right after it has finished detecting an event. The center sensor is also just above the center of the robot so when turning 180 degrees, the robot will start turning at the correct place now. See Appendix D, for visual representation of scenarios.

\subsubsection*{PCB Design}
For the PCB Design we had two mounting options: Through Hole Technology (THT) or Surface Mount Technology (SMT). The larger sizes of THT components, allow for more efficient prototyping, especially when soldering and desoldering components. That means if we need to modify our circuit, we can easily switch the component out or solder additional jumper wires. On the other hand, SMT components are much smaller which gives us more freedom over the placements of the components, especially when the board has size constraints. 
\\This allows us to minimise our track lengths and place our circuitry for each light sensor as close to our desired sensor arrangement as possible, which is vital for the performance of the robot. We decided to utilise SMT because it is standard industry practice due to low cost and efficient PCB design. Additionally, we included four DIP switches, two used for functionality, the other two used for testing. Two of the switches are used to change the mode (shortest path and traversing the map) of the robot and the other two are used to turn on the motor and/or the white tracking LEDS. To minimise the length of the tracks, anything fed into the PSoC was placed close to the male header pins. These include the light sensing circuits, voltage divider for the battery, switches and daughter board pins.

\subsubsection*{Testing \& Verification}
Testing and Verification of analogue design is a very important step in the development of a circuit. Verification is used to validate our theoretical design, whereas testing is used to ensure our design works and produces the outcome we desire. The iterations of our design were verified through hand-calculations and verification tools such as LTSpice, before testing our prototype using the oscilloscope and multimeter. Refer to Appendix E for simulations and oscilloscope measurements of our design.
\\We initially started with us testing different phototransistor configurations. After testing, the common-collector proved more appropriate for our application due to the accentuated voltages of black light and white light. The results of the tests also indicated our analogue design would need to include filtering to extract the signal of interest. 
\\The next phase of our design required us to verify different corner frequencies and gains of our active high-pass filter and check the outcomes. From extensive testing, it was found that changing the corner frequency to filter out the ambient light at 100Hz had no meaningful effect on the purity of the desired signal but would negatively affect the strength of it. Due to this, the next iteration of our filter design only focused on attenuating the DC component instead.
\\For the sensor array, a prototype representing the arrangement of sensors was created so we could test different arrangements and how well they would handle scenarios the robot may encounter. By creating a physical prototype of the arrangement, we could test the turning and intersection logic on the projected map itself.
\\After testing, we found the robot reacted too slow to turning events. The reaction time was improved by reducing the time constant of the circuit. A design with a smaller capacitor and resistor produced a significantly faster response time.

\subsubsection*{Final Circuit Design}
% \vspace{-0.5mm}
The final light sensing circuit  consists of a phototransistor in common-emitter configuration. The output of which, was filtered and amplified by a gain of 5.7 using an active high pass filter to have a signal in the 0-5V operating range and to accentuate the difference of the black and white light. A rectifier and smoothing capacitor with a time constant of 14.96 ms was used to convert the AC signal closer to a DC signal. This was then converted to a digital signal using a Schmitt-trigger to give a logic high output signal for black light and a logic low output signal for white light. The PCB was designed utilising Surface-mount technology with small surface-mount components, as this enabled us to easily place light sensor circuit in the necessary locations of the board according to our sensor array layout. Our final circuit design can be seen in Appendix B: Figure 3.